#
# 
# this file should be sourced from ~/.bash_profile
#
# This sets up ~/.aws for EC2 
#
basePath="$HOME/.aws"
toolsPath="$basePath/cli_tools/ec2-api-tools"
credPath="$basePath/creds"

if [ ! `echo $PATH | grep "$toolsPath"` ]
then
    export PATH="$PATH:$toolsPath/bin"
fi

export EC2_HOME="$toolsPath"

# pretty osx specific right now
export JAVA_HOME=/System/Library/Frameworks/JavaVM.framework/Home

# to modify the shell's environment we need to run 
# in the same environment (shell scripts are child envs)

function aws {
    ERROR=

    if [ -z $1 ]
    then
        available=$(ls -1 $credPath | tr "\n" "|" | sed 's/|$//')
        echo "Usage: aws [$available]"
        echo
        echo "Example: "
        echo "> aws `ls -1 $credPath | head -1`"
        echo
        echo "Current AWS Environment"
        echo "-----------------------"
        echo "AWS_ENV          = $AWS_ENV"
        echo "AWS_ACCESS_KEY   = $AWS_ACCESS_KEY"
        echo "AWS_SECRET_KEY   = `echo $AWS_SECRET_KEY | cut -c 1-5`..."
        echo
        ERROR="TRUE"
    fi

    if [ -z $ERROR ]
    then
        credFile="$credPath/$1"
        if [ ! -f $credFile ]
        then 
            echo "ERROR: Environment $1 path ($credFile) does not exist"
            ERROR="TRUE"
        fi
    fi

    if [ -z $ERROR ]
    then
        export AWS_ENV=$1
        source $credFile

        echo $1 > "$basePath/last"
    fi

}

export -f aws

# restore the previous setting
if [ -f $basePath/last ]; then
    aws $(cat $basePath/last)
fi
